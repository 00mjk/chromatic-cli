{"version":3,"sources":["../src/storybook-addon.js"],"names":["CHROMATIC_PARAMETERS","specFromStory","id","kind","name","parameters","chromatic","param","value","storyId","component","displayName","split","slice","reduce","acc","key","extract","global","__STORYBOOK_CLIENT_API__","Error","storyStore","_storyStore","Object","values","map","getStorybook","stories","getStoryAndParameters","a","b","__renderChromaticSpec__","assign","story","__STORYBOOK_ADDONS_CHANNEL__","channel","Promise","resolve","reject","on","document","getElementById","error","emit","_handleEvent","type","args","from","body","classList","contains","message","textContent","stack","isDeprecated","__chromaticRuntimeSpecs__","stripIndents"],"mappings":"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","sourcesContent":["/* eslint-disable no-underscore-dangle */\n/* eslint-env browser */\nimport { toId } from '@storybook/router/utils';\nimport deprecate from 'util-deprecate';\nimport { stripIndents } from 'common-tags';\n\nimport isChromatic from './isChromatic';\n\nconst CHROMATIC_PARAMETERS = [\n  'viewports',\n  'delay',\n  'disable',\n  'noScroll',\n  'diffThreshold',\n  'pauseAnimationAtEnd',\n];\n\nfunction specFromStory({ id, kind, name, parameters: { chromatic } = {} }) {\n  const param = value => (typeof value === 'function' ? value({ id, kind, name }) : value);\n  return {\n    storyId: id,\n    name,\n    component: {\n      name: kind,\n      displayName: kind.split(/\\||\\/|\\./).slice(-1)[0],\n    },\n    parameters:\n      chromatic &&\n      CHROMATIC_PARAMETERS.reduce(\n        (acc, key) => (chromatic[key] ? { ...acc, [key]: param(chromatic[key]) } : acc),\n        {}\n      ),\n  };\n}\n\nconst extract = global => {\n  const { __STORYBOOK_CLIENT_API__ } = global;\n\n  if (!__STORYBOOK_CLIENT_API__) {\n    throw new Error(\n      `Chromatic requires Storybook version at least 3.4. Please update your Storybook!`\n    );\n  }\n\n  const storyStore = __STORYBOOK_CLIENT_API__._storyStore;\n\n  // Storybook 5+ API\n  if (storyStore.extract) {\n    return Object.values(storyStore.extract()).map(specFromStory);\n  }\n\n  // Storybook 4- API\n  return __STORYBOOK_CLIENT_API__\n    .getStorybook()\n    .map(({ kind, stories }) =>\n      stories.map(({ name }) =>\n        specFromStory({\n          kind,\n          name,\n          parameters:\n            storyStore.getStoryAndParameters &&\n            storyStore.getStoryAndParameters(kind, name).parameters,\n        })\n      )\n    )\n    .reduce((a, b) => [...a, ...b], []); // flatten\n};\n\ndeprecate(\n  () => {\n    global.__renderChromaticSpec__ = Object.assign(\n      async ({ storyId, name: story, component: { name: kind } }) => {\n        const { __STORYBOOK_CLIENT_API__, __STORYBOOK_ADDONS_CHANNEL__ } = global;\n\n        if (!__STORYBOOK_CLIENT_API__ && !__STORYBOOK_ADDONS_CHANNEL__) {\n          throw new Error(\n            `Chromatic requires Storybook version at least 3.4. Please update your Storybook!`\n          );\n        }\n\n        const channel = __STORYBOOK_ADDONS_CHANNEL__;\n\n        // In Storybook 5+ we can be sure of the emitting, and we need to use a storyId API\n        if (__STORYBOOK_CLIENT_API__) {\n          return new Promise((resolve, reject) => {\n            channel.on('storyRendered', () => resolve(document.getElementById('root')));\n            channel.on('storyUnchanged', () => resolve(document.getElementById('root')));\n            channel.on('storyErrored', error => reject(error));\n            channel.on('storyThrewException', error => reject(error));\n            channel.on('storyMissing', () => reject(new Error('storyMissing')));\n\n            channel.emit('setCurrentStory', { storyId: storyId || toId(kind, story) });\n          });\n        }\n\n        // We need to emulate the event sent by the manager to the preview.\n        // In SB@4+ if we emit a message on the channel it will get picked up by the preview\n        // (note that we are on the preview side). However, in SB@3.4, perhaps more correctly,\n        // if we emit a message, it won't be picked up by the preview. So we need to reach\n        // in and simulate receiving an event\n        channel._handleEvent({\n          type: 'setCurrentStory',\n          args: [{ kind, story }],\n          from: 'chromatic',\n        });\n\n        // If the story has rendered with an error, SB does not return any kind of error\n        // (we will fix this...) However, in the meantime, you can pick this up via a class on the body\n        if (document.body.classList.contains('sb-show-errordisplay')) {\n          const message = document.getElementById('error-message').textContent;\n          const stack = document.getElementById('error-stack').textContent;\n          const error = new Error(message);\n          error.stack = stack;\n          throw error;\n        }\n\n        return document.getElementById('root');\n      },\n      { isDeprecated: true }\n    );\n    global.__chromaticRuntimeSpecs__ = Object.assign(async () => extract(global), {\n      isDeprecated: true,\n    });\n  },\n  stripIndents`\n    You're importing 'chromatic-cli' in your config.js\n    This is no longer necessary!\n\n    If you're importing { isChromatic } in your stories, please change that to:\n    \"import isChromatic from \"chromatic-cli/isChromatic\";\"\n  `\n)();\n\nexport { isChromatic };\n"],"file":"storybook-addon.js"}